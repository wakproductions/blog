<!DOCTYPE html>
<html>
  <head>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <meta charset='utf-8'>
    <meta content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no' name='viewport'>
    <!-- For Facebook link formatting -->
    <meta content='http://www.winstonkotzan.com/2016/09/12/graylog-apache-docker-using-gelf.html' property='og:url'>
    <meta content='article' property='og:type'>
    <meta content='Feeding Apache log files to Graylog with Docker and apache-mod_log_gelf' property='og:title'>
    <meta content='' property='og:description'>
    <meta content='http://www.winstonkotzan.com/blog/images/blog-default-social-media-image.jpg' property='og:image'>
    <meta content='' name='twitter:card'>
    <title>Feeding Apache log files to Graylog with Docker and apache-mod_log_gelf</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <link href="../../../stylesheets/site.css" rel="stylesheet" />
    <script src="../../../javascripts/all.js"></script>
    <script src="../../../javascripts/jquery-2.2.3.min.js"></script>
    
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-46648633-1', 'winstonkotzan.com');
        ga('send', 'pageview');
    </script>
  </head>
  <body class='x2016 x2016_09 x2016_09_12 x2016_09_12_graylog-apache-docker-using-gelf'>
    <div class='jumbotron'>
      <div class='container'>
        <div class='col-lg-offset-6 col-lg-6 blog-title-box'>
          <div class='content'>
            <a href="/blog/">Winston Kotzan's Technology Blog</a>
          </div>
        </div>
      </div>
    </div>
    <div class='container content'>
      <div class='col-md-8'>
        <div class='main article-content' role='main'>
          <h2 class='article-title'>Feeding Apache log files to Graylog with Docker and apache-mod_log_gelf</h2>
          <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
          <!-- article-top -->
          <ins class="adsbygoogle"
               style="display:inline-block;width:728px;height:90px"
               data-ad-client="ca-pub-9623179230776920"
               data-ad-slot="7383597095"></ins>
          <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
          </script>
          <div class='article-date'>09/12/2016</div>
          <div class='article-body'>
            <p><strong>Objective</strong>: Configure a Graylog server to accept GELF-formatted logs from an Apache web server. Both servers
            will be running on Docker, although we will adapt the Apache Docker setup instructions to set up an existing
            (non-Docker) Apache server running on Ubuntu 14.04. The logs are going to be sent to the Graylog server using
            UDP port 12201.</p>
            
            <h3>Docker Setup</h3>
            
            <pre><code class="yaml">version: &#39;2&#39;&#x000A;services:&#x000A;  apache:&#x000A;    depends_on:&#x000A;      - graylog&#x000A;    image: &quot;wakproductions/apache2-graylog-config&quot;&#x000A;    volumes:&#x000A;      - ~/Development/graylog-local/install-demos/apache2/etc/apache2/mods-enabled/log_gelf.conf:/etc/apache2/mods-enabled/log_gelf.conf&#x000A;    ports:&#x000A;      - &quot;3000:80&quot;&#x000A;  mongo:&#x000A;    image: &quot;mongo:3&quot;&#x000A;    volumes:&#x000A;      - ~/Development/graylog-local/data/mongo:/data/db&#x000A;  elasticsearch:&#x000A;    image: &quot;elasticsearch:2&quot;&#x000A;    command: &quot;elasticsearch -Des.cluster.name=&#39;graylog&#39;&quot;&#x000A;    volumes:&#x000A;      - ~/Development/graylog-local/data/elasticsearch:/usr/share/elasticsearch/data&#x000A;  graylog:&#x000A;    image: &quot;graylog2/server&quot;&#x000A;    volumes:&#x000A;      - ~/Development/graylog-local/data/journal:/usr/share/graylog/data/journal&#x000A;      - ~/Development/graylog-local/config:/usr/share/graylog/data/config&#x000A;    environment:&#x000A;      # GRAYLOG_WEB_ENDPOINT_URI: &quot;http://127.0.0.1:9000/api/&quot; # didn&#39;t like having this config here (tried looking for REST server at this address) - could be a bug&#x000A;      GRAYLOG_REST_TRANSPORT_URI: &quot;http://127.0.0.1:12900&quot;&#x000A;    depends_on:&#x000A;      - mongo&#x000A;      - elasticsearch&#x000A;    ports:&#x000A;      - &quot;9000:9000&quot;&#x000A;      - &quot;12900:12900&quot;&#x000A;      - &quot;5555:5555&quot;&#x000A;      - &quot;12201:12201/udp&quot;&#x000A;      - &quot;12201:12201&quot;&#x000A;</code></pre>
            
            <p><strong>docker-compose.yml</strong></p>
            
            <p>If using a preexisting Apache server, you could remove the <code>apache</code> block and dependency from the file. You&#39;ll just
            have to mirror the image setup instructions below to get the GELF module installed on your Apache server.</p>
            
            <h3>Apache Docker Image Setup (wakproductions/apache2-graylog-config)</h3>
            
            <p>For Apache to submit GELF logs to Graylog, there is a community-supported module named <a href="https://github.com/Graylog2/apache-mod_log_gelf">apache-mod_log_gelf</a>.</p>
            
            <pre><code>FROM webdevops/apache:ubuntu-14.04&#x000A;&#x000A;ENV WEB_DOCUMENT_INDEX index.html&#x000A;ADD app /app&#x000A;&#x000A;RUN apt-get update &amp;&amp; apt-get upgrade&#x000A;&#x000A;RUN a2dismod mpm_event&#x000A;RUN a2enmod mpm_prefork &amp;&amp; apt-get install libjson-c2 zlib1g&#x000A;&#x000A;RUN wget https://github.com/Graylog2/apache-mod_log_gelf/releases/download/0.2.0/libapache2-mod-gelf_0.2.0-1_amd64.ubuntu.deb&#x000A;RUN dpkg -i libapache2-mod-gelf_0.2.0-1_amd64.ubuntu.deb&#x000A;RUN a2enmod log_gelf &amp;&amp; restart apache&#x000A;</code></pre>
            
            <p><strong>Dockerfile</strong></p>
            
            <pre><code>GelfEnabled On&#x000A;GelfUrl &quot;udp://graylog:12201&quot;&#x000A;</code></pre>
            
            <p><strong>/etc/apache2/mods-enabled/log_gelf.conf</strong> <a href="https://github.com/Graylog2/apache-mod_log_gelf#configuration">Reference</a></p>
            
            <h4>Troubleshooting <code>docker build</code></h4>
            
            <p><strong>ERROR: Module mpm_event is enabled - cannot proceed due to conflicts. It needs to be disabled first!</strong></p>
            
            <p>I found a clue to fixing this problem <a href="http://askubuntu.com/questions/528866/apache-2-4-cannot-proceed-due-to-conflicts-with-module-mpm-prefork">here</a>.
            It was resolved by disabling <code>mpm_event</code> via the command <code>a2dismod mpm_event</code>.</p>
            
            <p><strong>dpkg: error processing archive libapache2-mod-gelf<em>0.1.0-1</em>amd64.deb (--install):</strong>
              <strong>cannot access archive: No such file or directory</strong></p>
            
            <p>The instructions on the apache-mod_log_gelf page were misleading. I overlooked the part that read: &quot;Download a package
            for your operating system from <a href="https://github.com/Graylog2/apache-mod_log_gelf/releases">here</a> Update Apache2 to the
            latests version and use mpm_prefork.&quot;</p>
            
            <p>To fix the error you have to follow that link and download the latest version of module into the working directory on
            the Apache server. So I added the following line:</p>
            
            <p><code>RUN wget https://github.com/Graylog2/apache-mod_log_gelf/releases/download/0.2.0/libapache2-mod-gelf_0.2.0-1_amd64.ubuntu.deb</code></p>
            
            <h3>Docker Networking Gotcha</h3>
            
            <h4>Getting the Apache server to see the Graylog server</h4>
            
            <p>It took me a while to figure out how to get the Apache server to talk to the Graylog server. Initially, I set the
            <code>GelfUrl &quot;udp:127.0.0.1:12201&quot;</code> but the Graylog server was not receiving anything. The problem was that this was the
            equivalent to the Apache server trying to connect to itself on UDP 12201. You have to use the bridge network IP
            address of the Graylog server, or refer to it by the network hostname assigned by the Docker network. Each
            container has a hostname respective to the name you assign it in the <code>docker-compose.yml</code> file.</p>
            
            <h3>Useful Terminal Commands</h3>
            
            <p>Build Apache server image:
            <code>docker build -t wakproductions/apache2-graylog-config .</code></p>
            
            <p>Send test message on port 5555 to Graylog (non-GELF) from Apache docker server
            <code>echo &quot;hello from apache&quot; | nc -vz graylog 5555</code></p>
            
            <p>Send GELF test message on port 12201 to Graylog from Apache docker server
            echo -e &#39;{&quot;version&quot;: &quot;1.1&quot;,&quot;host&quot;:&quot;example.org&quot;,&quot;short<em>message&quot;:&quot;Short message&quot;,&quot;full</em>message&quot;:&quot;Backtrace here\n\nmore stuff&quot;,&quot;level&quot;:1,&quot;<em>user</em>id&quot;:9001,&quot;<em>some</em>info&quot;:&quot;foo&quot;,&quot;<em>some</em>env_var&quot;:&quot;bar&quot;}\0&#39; | nc -u graylog 12201</p>
            
            <h3>Sample Graylog Configuration</h3>
            
            <div class="image-box">
              <div class="image-box-content">
                <a href="../../../images/2016/Pasted_Image_9_12_16__8_18_AM.png"><img src="../../../images/2016/Pasted_Image_9_12_16__8_18_AM.png" alt="Pasted image 9 12 16  8 18 am" /></a>
              </div>
            </div>
          </div>
          <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
          <!-- article-bottom -->
          <ins class="adsbygoogle"
               style="display:inline-block;width:336px;height:280px"
               data-ad-client="ca-pub-9623179230776920"
               data-ad-slot="8860330295"></ins>
          <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
          </script>
          <div id="disqus_thread"></div>
          <script>
          
            /**
             *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
            /*
             var disqus_config = function () {
             this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
             this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
             };
             */
            (function() { // DON'T EDIT BELOW THIS LINE
              var d = document, s = d.createElement('script');
              s.src = 'https://winstonkotzan.disqus.com/embed.js';
              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
            })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
      </div>
      <div class='col-md-4'>
        <aside>
          <h2>Recent Articles</h2>
          <ol>
            <li><a href="../../../2019/04/09/the-easy-guide-to-making-your-github-pages-site-https.html">The Easy Guide to Making Your Github Pages Site HTTPS</a> <span>Apr  9</span></li>
            <li><a href="../../../2019/04/03/docker-volumes-dont-make-this-mistake.html">Don't Make This Mistake When Using Docker Volumes!</a> <span>Apr  3</span></li>
            <li><a href="../../../2019/03/21/make-blog-posts-shareable-with-opengraph-meta-tags.html">Make Your Blog Posts Shareable with OpenGraph Meta Tags</a> <span>Mar 21</span></li>
            <li><a href="../../../2019/03/09/production-https-setup-for-ruby-on-rails-app-with-docker.html">How to Set Up HTTPS for Free on a Dockerized Ruby on Rails Production Server</a> <span>Mar  9</span></li>
            <li><a href="../../../2019/02/05/how-to-connect-docker-to-a-postgres-database-on-host-machine-localhost.html">How to connect a Docker application to a Postgres database on the host machine</a> <span>Feb  5</span></li>
            <li><a href="../../../2019/02/04/three-allergic-triggers-that-can-cause-eczema.html">Three Allergic Triggers That Can Cause Eczema</a> <span>Feb  4</span></li>
            <li><a href="../../../2019/02/03/i-conquered-eczema-after-30-years-of-itchy-skin-and-you-can-too.html">I Conquered Eczema after 30 Years of Itchy Skin, And You Can Too</a> <span>Feb  3</span></li>
            <li><a href="../../../2018/03/05/how-to-install-node-on-ruby-5-debian-stretch-docker-container.html">How to Node on Ruby 2.5.0 (Debian Stretch) Docker Container</a> <span>Mar  5</span></li>
            <li><a href="../../../2018/01/30/how-to-install-twitter-bootstrap-into-webpack-react-application.html">How to Install Twitter Bootstrap into a Webpack/React.js Application</a> <span>Jan 30</span></li>
            <li><a href="../../../2018/01/29/webpack-compile-scss-insanity.html">Compiling SCSS to CSS in Webpack - INSANITY!</a> <span>Jan 29</span></li>
          </ol>
          <h2>By Year</h2>
          <ol>
            <li><a href="../../../2019.html">2019 (7)</a></li>
            <li><a href="../../../2018.html">2018 (4)</a></li>
            <li><a href="../../../2017.html">2017 (20)</a></li>
            <li><a href="../../../2016.html">2016 (7)</a></li>
          </ol>
          <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
          <!-- Sidebar ad -->
          <ins class="adsbygoogle"
               style="display:inline-block;width:300px;height:600px"
               data-ad-client="ca-pub-9623179230776920"
               data-ad-slot="2953397495"></ins>
          <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
          </script>
        </aside>
      </div>
    </div>
  </body>
</html>
